name: ðŸ§ª Asisya API - Tests

on:
  pull_request:
  push:
    branches: [ main, develop ]

jobs:
  run-tests:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: asisya_user
          POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
          POSTGRES_DB: asisya_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U asisya_user -d asisya_db"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

      localstack:
        image: localstack/localstack
        env:
          SERVICES: sqs,s3,lambda
          AWS_DEFAULT_REGION: us-east-1
        ports:
          - 4566:4566

    env:
      # ==== App Config ====
      API_VERSION: 0.0.1
      DEBUG_MODE: true

      # ==== Database ====
      DB_HOST: localhost
      DB_PORT: 5433
      DB_NAME: asisya_db
      DB_USER: asisya_user
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DATABASE_URL: postgresql://asisya_user:${{ secrets.DB_PASSWORD }}@localhost:5433/asisya_db

      # ==== Admin Account ====
      INITIAL_ADMIN_USERNAME: ${{ secrets.INITIAL_ADMIN_USERNAME }}
      INITIAL_ADMIN_EMAIL: ${{ secrets.INITIAL_ADMIN_EMAIL }}
      INITIAL_ADMIN_PASSWORD: ${{ secrets.INITIAL_ADMIN_PASSWORD }}

      # ==== JWT / Security ====
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      ALGORITHM: ${{ secrets.ALGORITHM }}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}

      # ==== SMTP ====
      USE_SMTP: false
      SMTP_SERVER: your.smtp.server.com
      SMTP_PORT: 1234
      SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
      SENDER_EMAIL: ${{ secrets.SMTP_USERNAME }}

      # === STORAGE MODE ===
      STORAGE_BACKEND: local
      PROJECT_ROOT: /home/runner/work/FullStackTest/FullStackTest

      # === AWS / LocalStack ===
      AWS_S3_BUCKET: asisya-media
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      BULK_PRODUCTS_QUEUE_URL: http://localhost:4566/000000000000/bulk-products-queue
      AWS_ENDPOINT_URL: http://localhost:4566
      AWS_DEFAULT_REGION: us-east-1
      PYTHONPATH: asisya_api

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      - name: ðŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install awscli pytest

      - name: ðŸ§± Run Alembic migrations
        run: alembic -c asisya_api/infrastructure/alembic.ini upgrade head

      - name: ðŸŒ± Seed initial data
        run: python -m asisya_api.infrastructure.seeds.seed_initial_data

      - name: â˜ï¸ Create LocalStack resources
        run: |
          aws --endpoint-url=http://localhost:4566 sqs create-queue --queue-name bulk-products-queue
          aws --endpoint-url=http://localhost:4566 s3 mb s3://asisya-bucket
          echo "print('Lambda mock')" > handler.py
          zip lambda.zip handler.py
          aws --endpoint-url=http://localhost:4566 lambda create-function \
            --function-name processBulkProducts \
            --runtime python3.12 \
            --role arn:aws:iam::000000000000:role/lambda-role \
            --handler handler.lambda_handler \
            --zip-file fileb://lambda.zip

      - name: ðŸ§ª Run tests
        run: pytest -v --disable-warnings
